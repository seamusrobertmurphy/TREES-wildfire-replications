---
title: "Burn Area"
execute:
  echo: true
format:
  html:
    toc: true
    toc-location: right
    toc-depth: 3
    toc-title: "**On this page**"
    highlight-style: pygments
    page-layout: article

editor_options: 
  markdown: 
    wrap: 60
engine: knitr
bibliography: ../references/references.bib
csl: ../references/apa.csl
citeproc: true
---

## Overview {.unnumbered}

This chapter describes the classification of burned areas
into IPCC-compliant vegetation categories using MODIS Land
Cover (MCD12Q1) and auxiliary datasets. The classification
determines which emission factors and fuel consumption
values apply to each burned pixel, directly impacting
greenhouse gas emission estimates.

------------------------------------------------------------

### IPCC Vegetation Categories {#sec-veg-ipcc-categories}

FAOSTAT implements three primary fire categories aligned
with IPCC 2006 Guidelines [@intergovernmental2006chapter]:

1\. Forest Fires:

-   Humid Tropical Forest: Fires in tropical moist
    ecological zones
-   Other Forest: All remaining forest types (boreal,
    temperate, tropical dry)

2\. Savanna Fires (Grassland):

-   Grassland
-   Savanna
-   Woody Savanna
-   Open Shrubland
-   Closed Shrubland

3\. Fires in Organic Soils:

-   Peatland fires (Histosols classification)
-   Independent of overlying vegetation

### Classification Decision Tree {#sec-veg-decision-tree}

```{r}
#| eval: false
#| label: veg-decision-tree
#| echo: false

# Conceptual decision tree (not executable code)
# 
# For each burned pixel:
#   ├─ Is pixel on Histosol? 
#   │   └─ YES → Organic Soil Fire
#   │   └─ NO → Continue
#   ├─ Is land cover = Forest (Classes 1-5)?
#   │   ├─ YES → Is pixel in Tropical Moist zone?
#   │   │   ├─ YES → Humid Tropical Forest Fire
#   │   │   └─ NO → Other Forest Fire
#   │   └─ NO → Continue
#   ├─ Is land cover = Grassland/Savanna/Shrubland (Classes 6-10)?
#   │   └─ YES → Savanna Fire
#   └─ ELSE → Not classified (excluded from analysis)
```

### Vegetation Reporting Requirements {#sec-veg-reporting}

Following IPCC guidelines:

| Vegetation Type    | CO₂ | CH₄ | N₂O | Rationale                   |
|--------------------|-----|-----|-----|-----------------------------|
| Forest Fires       | ❌  | ✅  | ✅  | CO₂ in carbon stock changes |
| Savanna Fires      | ❌  | ✅  | ✅  | Assumes annual CO₂ balance  |
| Organic Soil Fires | ✅  | ✅  | ❌  | Per Wetlands Supplement     |

Key principle: CO₂ from non-stand-replacing fires assumed
balanced by regrowth within one year (IPCC 2019, Section
2.4).

------------------------------------------------------------

## MODIS Land Cover Classification {#sec-veg-modis}

### MCD12Q1 IGBP Classification Scheme {#sec-veg-igbp}

#### Product Overview {#sec-veg-mcd12q1-overview}

-   GEE Asset: `MODIS/061/MCD12Q1`
-   Spatial Resolution: 500m
-   Temporal Resolution: Annual (2001-present)
-   Classification System: Land Cover Type 1 - IGBP
    (International Geosphere-Biosphere Programme)
    -   Algorithm: Supervised classification using Random
        Forest trained on reference sites
    -   Overall Accuracy: \~75% globally [@sulla2018user]

### IGBP Burnable Classes

Forest Classes (1-5):

| Class | Name | IPCC Category | Fuel Consumption (t ha⁻¹) |
|------------|------------|-------------|-------------------------|
| 1 | Evergreen Needleleaf Forests | Other Forest | 41.0 (mean) |
| 2 | Evergreen Broadleaf Forests | Humid Tropical Forest | 119.6 (mean) |
| 3 | Deciduous Needleleaf Forests | Other Forest | 41.0 (mean) |
| 4 | Deciduous Broadleaf Forests | Other/Tropical (zone-dependent) | 69.4-119.6 |
| 5 | Mixed Forests | Other Forest | 50.4 (mean) |

Grassland/Savanna Classes (6-10):

| Class | Name | IPCC Category | Fuel Consumption (t ha⁻¹) |
|----|----|----|----|
| 6 | Closed Shrublands | Savanna (Shrubland) | 14.3 (mean) |
| 7 | Open Shrublands | Savanna (Shrubland) | 14.3 (mean) |
| 8 | Woody Savannas | Savanna (Woody) | 2.6-4.6 (season) |
| 9 | Savannas | Savanna | 2.1-10.0 (season) |
| 10 | Grasslands | Savanna (Grassland) | 2.1-10.0 (season) |

Excluded Classes:

| Class | Name | Reason for Exclusion |
|----|----|----|
| 0 | Water | Not burnable |
| 11 | Permanent Wetlands | Handled separately if Histosol |
| 12 | Croplands | Agricultural fires (separate category) |
| 13 | Urban and Built-up | Fire prevention/suppression active |
| 14 | Cropland/Natural Vegetation Mosaics | Ambiguous, often excluded |
| 15 | Permanent Snow and Ice | Not burnable |
| 16 | Barren | Insufficient fuel |
| 17 | Unclassified | No data |

### Earth Engine: MCD12Q1 {#sec-veg-gee-access}

```{r}
#| eval: false
#| label: veg-mcd12q1-access
#| code-summary: "Load MODIS Land Cover"

library(rgee)
ee_Initialize()

# Load land cover collection
landCover <- ee$ImageCollection("MODIS/061/MCD12Q1")

# Select IGBP classification (Type 1)
igbp <- landCover$select("LC_Type1")

# Get land cover for specific year (example: 2023)
lc_2023 <- igbp$
  filterDate("2023-01-01", "2023-12-31")$
  first()

# Visualize
lc_vis <- list(
  min = 1,
  max = 17,
  palette = c(
    '05450a', '086a10', '54a708', '78d203', '009900',  # Forests 1-5
    'c6b044', 'dcd159', 'dade48', 'fbff13', 'b6ff05',  # Savanna/Grass 6-10
    'c24f44', 'a5a5a5', 'ff6d4c', '69fff8', 'f9ffa4',  # Other 11-15
    '1c0dff', 'ffffff'                                   # Barren/Unclass 16-17
  )
)

Map$addLayer(lc_2023, lc_vis, "IGBP Land Cover 2023")
```

### Land Cover Validation and Uncertainty {#sec-veg-lc-uncertainty}

Known Classification Issues:

1.  Woody Savanna vs. Open Forest: Confusion in transition
    zones
2.  Grassland vs. Cropland: Agricultural areas misclassified
3.  Seasonal Deciduous Forests: May shift between
    forest/savanna
4.  Temporal Lag: Land use changes not immediately reflected

Regional Accuracy (Sulla-Menashe & Friedl, 2022):

| Region        | Overall Accuracy | Forest Accuracy | Savanna Accuracy |
|---------------|------------------|-----------------|------------------|
| Africa        | 73%              | 68%             | 78%              |
| South America | 77%              | 82%             | 71%              |
| Europe        | 79%              | 86%             | 65%              |
| Asia          | 74%              | 75%             | 73%              |
| North America | 81%              | 88%             | 74%              |

------------------------------------------------------------

## Forest Fire Classification {#sec-veg-forest}

### Forest Type Identification {#sec-veg-forest-identify}

```{r}
#| eval: false
#| label: veg-forest-classification
#| code-summary: "Classify forest fires"

# Define forest classes (IGBP 1-5)
FOREST_CLASSES <- c(1, 2, 3, 4, 5)

# Function to extract forest mask
extractForest <- function(lc_image) {
  lc <- lc_image$select("LC_Type1")
  
  # Create forest mask
  forest_mask <- lc$eq(1)$  # Evergreen Needleleaf
    Or(lc$eq(2))$           # Evergreen Broadleaf
    Or(lc$eq(3))$           # Deciduous Needleleaf
    Or(lc$eq(4))$           # Deciduous Broadleaf
    Or(lc$eq(5))            # Mixed Forests
  
  return(forest_mask$rename("forest_mask"))
}

# Apply to land cover
forest_mask_2023 <- extractForest(lc_2023)

# Overlay with burned area (from Chapter 1)
# Assuming annual_burned_2023 is available from Chapter 1
forest_fires_2023 <- annual_burned_2023$
  updateMask(forest_mask_2023)

# Visualize
Map$addLayer(
  forest_fires_2023,
  list(palette = "red"),
  "Forest Fires 2023"
)
```

### Humid Tropical Forest Delineation {#sec-veg-humid-tropical}

#### FAO-FRA Global Ecological Zones {#sec-veg-fao-ecozones}

Dataset: FAO-FRA Global Ecological Zones 2010 Update

Tropical Moist Zones (for Humid Tropical Forest):

-   Tropical rainforest
-   Tropical moist deciduous forest
-   Tropical mountain systems (in moist zones)

Implementation:

```{r}
#| eval: false
#| label: veg-humid-tropical
#| code-summary: "Identify Humid Tropical Forest fires"

# Note: FAO-FRA zones not directly in GEE
# Alternative 1: Use climate proxy (precipitation + temperature)
# Alternative 2: Upload FAO zones as asset

# METHOD 1: Climate-based proxy
# Load WorldClim precipitation
precip <- ee$Image("WORLDCLIM/V1/BIO")$select("bio12")  # Annual precip

# Load temperature
temp <- ee$Image("WORLDCLIM/V1/BIO")$select("bio01")  # Annual mean temp

# Define tropical moist criteria (simplified)
# Tropical: Mean annual temp > 18°C
# Moist: Annual precip > 1500mm
tropical <- temp$gt(180)  # WorldClim temp in °C * 10
moist <- precip$gt(1500)

humid_tropical_mask <- tropical$And(moist)

# Combine with forest mask
humid_tropical_forest <- forest_mask_2023$And(humid_tropical_mask)

# Other forest = all forests NOT in humid tropical zones
other_forest <- forest_mask_2023$And(humid_tropical_mask$Not())

# Overlay with burned areas
htf_fires_2023 <- annual_burned_2023$updateMask(humid_tropical_forest)
other_fires_2023 <- annual_burned_2023$updateMask(other_forest)

# Visualize
Map$addLayer(htf_fires_2023, list(palette = "darkred"), "Humid Tropical Fires")
Map$addLayer(other_fires_2023, list(palette = "orange"), "Other Forest Fires")
```

```{r}
#| eval: false
#| label: veg-fao-zones-asset
#| code-summary: "Using FAO-FRA zones as GEE asset (if available)"

# If FAO-FRA zones uploaded as asset
# (User would need to upload this manually)

# Load FAO zones (example path)
fao_zones <- ee$FeatureCollection("users/your_username/FAO_FRA_EcoZones")

# Filter to tropical moist zones
tropical_moist_zones <- fao_zones$filter(
  ee$Filter$inList("GEZ_NAME", list(
    "Tropical rainforest",
    "Tropical moist deciduous forest",
    "Tropical mountain systems"
  ))
)

# Rasterize to match MODIS resolution
tropical_moist_raster <- tropical_moist_zones$
  reduceToImage(
    properties = list("GEZ_CODE"),
    reducer = ee$Reducer$first()
  )$
  reproject(crs = lc_2023$projection(), scale = 500)

# Create mask
humid_tropical_mask_fao <- tropical_moist_raster$gt(0)

# Apply to forest fires
htf_fires_fao <- annual_burned_2023$
  updateMask(forest_mask_2023)$
  updateMask(humid_tropical_mask_fao)
```

### Forest Fire Area Calculation {#sec-veg-forest-area}

```{r}
#| eval: false
#| label: veg-forest-area-calc
#| code-summary: "Calculate forest fire areas by type"

# Define area of interest (from Chapter 1)
# Assuming 'aoi' is defined (e.g., country boundary)

# Function to calculate area
calculateForestFireArea <- function(fire_image, mask, name) {
  area_ha <- fire_image$
    updateMask(mask)$
    multiply(ee$Image$pixelArea()$divide(10000))$
    reduceRegion(
      reducer = ee$Reducer$sum(),
      geometry = aoi,
      scale = 500,
      maxPixels = 1e9
    )
  
  return(ee$Feature(NULL, list(
    fire_type = name,
    area_ha = area_ha$get("burned")
  )))
}

# Calculate areas
htf_area <- calculateForestFireArea(
  annual_burned_2023, 
  humid_tropical_forest,
  "Humid Tropical Forest"
)

other_forest_area <- calculateForestFireArea(
  annual_burned_2023,
  other_forest,
  "Other Forest"
)

# Combine results
forest_fire_stats <- ee$FeatureCollection(list(
  htf_area,
  other_forest_area
))

# Export or retrieve
forest_results <- ee_as_sf(forest_fire_stats) %>%
  st_drop_geometry() %>%
  as.data.frame()

print(forest_results)
```

------------------------------------------------------------

## Savanna Fire Classification {#sec-veg-savanna}

### Grassland and Woody Vegetation Types {#sec-veg-savanna-types}

```{r}
#| eval: false
#| label: veg-savanna-classification
#| code-summary: "Classify savanna fires by vegetation type"

# Define savanna/grassland classes
SAVANNA_CLASSES <- list(
  grassland = 10,
  savanna = 9,
  woody_savanna = 8,
  open_shrubland = 7,
  closed_shrubland = 6
)

# Extract each vegetation type
extractSavannaType <- function(lc_image, class_value, class_name) {
  mask <- lc_image$select("LC_Type1")$eq(class_value)
  return(mask$rename(class_name))
}

# Create masks for each type
grassland_mask <- extractSavannaType(lc_2023, 10, "grassland")
savanna_mask <- extractSavannaType(lc_2023, 9, "savanna")
woody_savanna_mask <- extractSavannaType(lc_2023, 8, "woody_savanna")
open_shrub_mask <- extractSavannaType(lc_2023, 7, "open_shrubland")
closed_shrub_mask <- extractSavannaType(lc_2023, 6, "closed_shrubland")

# Combined savanna mask (all types)
savanna_all_mask <- grassland_mask$
  Or(savanna_mask)$
  Or(woody_savanna_mask)$
  Or(open_shrub_mask)$
  Or(closed_shrub_mask)

# Overlay with burned areas
savanna_fires_2023 <- annual_burned_2023$updateMask(savanna_all_mask)

# Visualize
Map$addLayer(
  savanna_fires_2023,
  list(palette = "yellow"),
  "Savanna Fires 2023"
)
```

### Climate Zone Stratification {#sec-veg-climate-stratification}

Rationale: Fuel consumption varies by climate (IPCC Table
2.4)

IPCC Climate Zones:

-   Boreal (Cold)
-   Temperate (Warm/Cool)
-   Tropical (Wet/Moist/Dry/Montane)

```{r}
#| eval: false
#| label: veg-climate-zones
#| code-summary: "Apply IPCC climate zone stratification"

# Load JRC Climate Zones (IPCC-based)
# Note: May need to upload as asset if not in GEE catalog

# Alternative: Use temperature/precipitation proxies
# Load WorldClim data
bio01 <- ee$Image("WORLDCLIM/V1/BIO")$select("bio01")  # Annual mean temp
bio12 <- ee$Image("WORLDCLIM/V1/BIO")$select("bio12")  # Annual precip

# Define climate zones (simplified)
# Tropical: MAT > 18°C
tropical_zone <- bio01$gt(180)

# Boreal: MAT < 0°C
boreal_zone <- bio01$lt(0)

# Temperate: Everything else
temperate_zone <- bio01$gte(0)$And(bio01$lte(180))

# Apply to savanna fires
savanna_tropical <- savanna_fires_2023$updateMask(tropical_zone)
savanna_temperate <- savanna_fires_2023$updateMask(temperate_zone)
savanna_boreal <- savanna_fires_2023$updateMask(boreal_zone)

# Visualize climate-stratified fires
Map$addLayer(savanna_tropical, list(palette = "red"), "Tropical Savanna Fires")
Map$addLayer(savanna_temperate, list(palette = "orange"), "Temperate Savanna Fires")
Map$addLayer(savanna_boreal, list(palette = "blue"), "Boreal Savanna Fires")
```

### Seasonal Burn Patterns {#sec-veg-seasonal}

Importance: Fuel consumption differs between early/late dry
season (IPCC Table 2.4)

-   Early dry season: Lower fuel consumption (2.6 t ha⁻¹
    savanna woodland)
-   Late dry season: Higher fuel consumption (4.6 t ha⁻¹
    savanna woodland)

```{r}
#| eval: false
#| label: veg-seasonal-analysis
#| code-summary: "Analyze seasonal fire patterns"

# Extract burn month from burn date
extractBurnMonth <- function(mcd64_image) {
  burn_date <- mcd64_image$select("BurnDate")
  
  # Get image date (represents the month)
  img_date <- ee$Date(mcd64_image$get("system:time_start"))
  month <- img_date$get("month")
  
  # Create month band
  month_band <- ee$Image$constant(month)$
    updateMask(burn_date$gt(0))$
    rename("burn_month")
  
  return(burn_date$addBands(month_band))
}

# Apply to monthly collection (from Chapter 1)
mcd64_with_months <- mcd64_faostat$  # From Chapter 1
  filterDate("2023-01-01", "2023-12-31")$
  map(extractBurnMonth)

# Extract months as separate images
month_composite <- mcd64_with_months$
  select("burn_month")$
  max()  # Takes the latest month if pixel burned multiple times

# Define seasons (example for Southern Hemisphere savanna)
# Early dry season: May-July (months 5-7)
# Late dry season: August-October (months 8-10)

early_season <- month_composite$gte(5)$And(month_composite$lte(7))
late_season <- month_composite$gte(8)$And(month_composite$lte(10))

# Apply to savanna fires
savanna_early <- savanna_fires_2023$updateMask(early_season)
savanna_late <- savanna_fires_2023$updateMask(late_season)

# Calculate areas
early_area <- savanna_early$
  multiply(ee$Image$pixelArea()$divide(10000))$
  reduceRegion(reducer = ee$Reducer$sum(), geometry = aoi, scale = 500)

late_area <- savanna_late$
  multiply(ee$Image$pixelArea()$divide(10000))$
  reduceRegion(reducer = ee$Reducer$sum(), geometry = aoi, scale = 500)

print(paste("Early season:", early_area$getInfo()$burned, "ha"))
print(paste("Late season:", late_area$getInfo()$burned, "ha"))
```

------------------------------------------------------------

## Organic Soil Fire Classification {#sec-veg-organic}

### Histosols Identification {#sec-veg-histosols}

-   Dataset: Harmonized World Soil Database (HWSD v1.2)
-   Histosols: Organic soils with \> 20-30% organic matter
    by weight
-   Detection Challenge: Fires in organic soils independent
    of surface land cover

```{r}
#| eval: false
#| label: veg-histosols-access
#| code-summary: "Identify organic soil fires"

# Note: HWSD not directly in GEE
# Two approaches:
# 1. Upload HWSD as asset
# 2. Use existing peatland datasets in GEE

# APPROACH 1: Using Global Peatland Dataset
# (Example: Several peatland datasets exist in GEE catalog)

# Search for peatland/wetland datasets
# Example using a hypothetical peatland layer
# Actual implementation depends on available datasets

# For FAOSTAT methodology: Upload HWSD Histosols layer
# (User action required)

# APPROACH 2: Simplified proxy using permanent wetlands + tropical
wetlands_mask <- lc_2023$select("LC_Type1")$eq(11)  # Permanent wetlands

# Focus on Southeast Asia (where validated)
# Define Southeast Asia bounding box
sea_bbox <- ee$Geometry$Rectangle([95, -10, 141, 20])

# Peatland proxy: Wetlands in SE Asia lowlands
elevation <- ee$Image("USGS/SRTMGL1_003")
lowlands <- elevation$lt(100)  # < 100m elevation

organic_soil_mask <- wetlands_mask$
  And(lowlands)$
  clip(sea_bbox)

# Overlay with burned areas
organic_fires_2023 <- annual_burned_2023$
  updateMask(organic_soil_mask)

# Visualize
Map$addLayer(
  organic_fires_2023,
  list(palette = "brown"),
  "Organic Soil Fires 2023 (SE Asia)"
)
```

### Regional Constraints {#sec-veg-organic-regional}

FAOSTAT approach (per methodology guide):

> "Due to the current lack of evidence for other regions of
> the world, we set to 0 all the country values outside
> Southeastern Asia."

Southeast Asian Countries (non-zero organic soil fires):

-   Indonesia
-   Malaysia
-   Brunei Darussalam
-   (Potentially: Philippines, Thailand, Vietnam - check
    FAOSTAT regional definition)

```{r}
#| eval: false
#| label: veg-sea-filter
#| code-summary: "Apply Southeast Asia regional filter"

# Load country boundaries
countries <- ee$FeatureCollection("FAO/GAUL/2015/level0")

# Define Southeast Asia countries
SEA_COUNTRIES <- c(
  "Indonesia",
  "Malaysia",
  "Brunei Darussalam"
  # Add others as per FAOSTAT definition
)

# Filter to SE Asia
sea_countries <- countries$filter(
  ee$Filter$inList("ADM0_NAME", SEA_COUNTRIES)
)

# Clip organic fires to SE Asia only
organic_fires_sea <- organic_fires_2023$clip(sea_countries)

# All organic fires outside SE Asia = 0 (per FAOSTAT)
# (Achieved by clipping to SE Asia only)

# Calculate area
organic_area_sea <- organic_fires_sea$
  multiply(ee$Image$pixelArea()$divide(10000))$
  reduceRegions(
    collection = sea_countries,
    reducer = ee$Reducer$sum(),
    scale = 500
  )

# Results
organic_results <- ee_as_sf(organic_area_sea) %>%
  st_drop_geometry() %>%
  select(ADM0_NAME, sum) %>%
  rename(country = ADM0_NAME, area_ha = sum)

print(organic_results)
```

### Uncertainty in Organic Soil Classification {#sec-veg-organic-uncertainty}

High uncertainty sources (IPCC 2014 Wetlands Supplement):

1.  Detection limitations:

-   Smoldering fires difficult to detect via optical remote
    sensing
-   Dense canopy obscures ground fires

2.  Soil classification uncertainty:

-   HWSD spatial resolution (\~1km) coarser than fire
    detection (500m)
-   Organic soil depth variable within pixels
-   Drainage status unknown (drained vs. undrained)

3.  Fire depth uncertainty:

-   Surface burn vs. deep peat burn
-   Fuel consumption highly variable: 41 ± 1.4 t ha⁻¹ (IPCC
    Table 2.6)

FAOSTAT approach: Conservative reporting (SE Asia only)
until more validation data available

------------------------------------------------------------

## Multi-Source Validation of Vegetation Classification {#sec-veg-validation}

### GLAD Forest Height for Forest/Non-Forest Validation {#sec-veg-glad-height}

```{r}
#| eval: false
#| label: veg-glad-height-validation
#| code-summary: "Validate forest classification with GLAD height"

library(forestdata)
library(terra)

# Download GLAD forest height (example: Portugal)
glad_height <- fd_forest_glad(
  lon = -7.8,
  lat = 42.7,
  model = "height",
  year = 2020
)

# Forest threshold: > 5m height (per IPCC definition)
glad_forest_mask <- glad_height > 5

# Resample MODIS to GLAD resolution (30m) for comparison
# (Or aggregate GLAD to MODIS 500m)
glad_forest_500m <- aggregate(
  glad_forest_mask,
  fact = round(500 / 30),  # ~17x aggregation
  fun = mean  # Proportion of 30m pixels that are forest
)

# Export MODIS forest from GEE for comparison
modis_forest_mask_r <- ee_as_rast(
  forest_mask_2023,
  region = ee$Geometry$Point(c(-7.8, 42.7))$buffer(50000),  # 50km radius
  scale = 500
)

# Compare classifications
library(caret)
# Ensure same extent and resolution
glad_crop <- crop(glad_forest_500m, modis_forest_mask_r)
modis_crop <- crop(modis_forest_mask_r, glad_forest_500m)

# Confusion matrix
confusion <- confusionMatrix(
  data = as.factor(as.vector(modis_crop > 0)),
  reference = as.factor(as.vector(glad_crop > 0.5))  # >50% forest in aggregated pixel
)

print(confusion)

# Kappa statistic
print(paste("Cohen's Kappa:", round(confusion$overall["Kappa"], 3)))
```

### ESRI Land Cover for High-Resolution Validation {#sec-veg-esri-validation}

```{r}
#| eval: false
#| label: veg-esri-lc-validation
#| code-summary: "Validate with ESRI 10m land cover"

library(forestdata)

# Download ESRI land cover (10m resolution)
esri_lc_2023 <- fd_landcover_esri(utm_code = "29N", year = 2023)

# ESRI legend (verify from documentation):
# 1 = Water
# 2 = Trees
# 3 = Grass
# 4 = Flooded Vegetation
# 5 = Crops
# 6 = Scrub/Shrub
# 7 = Built Area
# 8 = Bare Ground
# 9 = Snow/Ice
# 10 = Clouds

# Extract forest (Trees class)
esri_forest <- esri_lc_2023 == 2

# Extract savanna (Grass + Scrub/Shrub)
esri_savanna <- (esri_lc_2023 == 3) | (esri_lc_2023 == 6)

# Aggregate to MODIS resolution
esri_forest_500m <- aggregate(
  esri_forest,
  fact = 50,  # 10m to 500m
  fun = mean
)

esri_savanna_500m <- aggregate(
  esri_savanna,
  fact = 50,
  fun = mean
)

# Calculate agreement with MODIS
# (Code similar to GLAD validation above)

# Overlay with burned areas
# Areas of disagreement may indicate:
# - MODIS misclassification
# - ESRI misclassification
# - Actual mixed pixels (forest edge, mosaic)
```

### EU-Trees4F Species Distribution {#sec-veg-eutrees-validation}

```{r}
#| eval: false
#| label: veg-eutrees-validation
#| code-summary: "Validate European forest types with species data"

library(forestdata)

# Download species distribution for key European forest types
# Example: Pinus pinaster (Maritime Pine) - fire-prone species

pinus_pinaster <- fd_forest_eutrees4f(
  species = "Pinus pinaster",
  period = "2005",
  type = "prob",
  distrib = "nat"
)

# High probability areas should align with "Other Forest" classification
# (Pinus pinaster = Evergreen Needleleaf in Portugal/Spain)

# Overlay with MODIS forest fires
# Expect fires in areas with:
# - High Pinus pinaster probability
# - MODIS Evergreen Needleleaf classification (class 1)
# - Mediterranean climate zone

# This validates:
# 1. MODIS correctly classifies needleleaf forests
# 2. These forests are burning (expected for fire-adapted species)
# 3. Climate stratification is appropriate
```

### Chorological Maps for Forest Type Verification {#sec-veg-chorological}

```{r}
#| eval: false
#| label: veg-chorological-validation
#| code-summary: "Use chorological maps to validate forest classifications"

library(forestdata)
library(sf)

# Download chorological maps for dominant European tree species
quercus_suber <- fd_forest_chorological(
  species = "Quercus suber",  # Cork Oak
  range = "nat"
)

pinus_pinaster <- fd_forest_chorological(
  species = "Pinus pinaster",  # Maritime Pine
  range = "nat"
)

# Plot species ranges
plot(quercus_suber$geometry, col = "green", main = "Cork Oak Native Range")
plot(pinus_pinaster$geometry, col = "blue", add = TRUE)

# Overlay with MODIS forest classification
# Cork Oak (broadleaf evergreen) should align with IGBP class 2
# Maritime Pine (needleleaf evergreen) should align with IGBP class 1

# Extract MODIS classification within species ranges
# (Requires converting MODIS to vector or resampling species to raster)
```

------------------------------------------------------------

## Complete Vegetation Classification Workflow {#sec-veg-workflow}

### Integrated Processing Pipeline {#sec-veg-pipeline}

```{r}
#| eval: false
#| label: veg-complete-workflow
#| code-summary: "End-to-end vegetation classification"

# ============================================================
# IPCC Tier 1 Vegetation Classification Pipeline
# Integrates: MCD64A1 + MCD12Q1 + FAO Zones + HWSD
# ============================================================

library(rgee)
library(sf)
library(tidyverse)

ee_Initialize()

# 1. LOAD INPUTS ----------------------------------------------
# Burned area (from Chapter 1)
year <- 2023
mcd64 <- ee$ImageCollection("MODIS/061/MCD64A1")$
  filterDate(paste0(year, "-01-01"), paste0(year, "-12-31"))

# Land cover
lc <- ee$ImageCollection("MODIS/061/MCD12Q1")$
  filterDate(paste0(year, "-01-01"), paste0(year, "-12-31"))$
  first()$
  select("LC_Type1")

# Country boundary
countries <- ee$FeatureCollection("FAO/GAUL/2015/level0")
country_name <- "Portugal"
aoi <- countries$filter(ee$Filter$eq("ADM0_NAME", country_name))

# 2. PROCESS BURNED AREA --------------------------------------
# Quality filter and annual aggregation (from Chapter 1)
filterQuality <- function(img) {
  mask <- img$select("Burn_Date_Uncertainty")$lt(20)$
    And(img$select("BurnDate")$gt(0))
  return(img$updateMask(mask))
}

annual_burn <- mcd64$
  map(filterQuality)$
  select("BurnDate")$
  max()$
  gt(0)$
  selfMask()

# 3. CLASSIFY VEGETATION TYPES --------------------------------

# 3a. Forest Fires
forest_mask <- lc$gte(1)$And(lc$lte(5))

# Humid Tropical Forest (using climate proxy)
temp <- ee$Image("WORLDCLIM/V1/BIO")$select("bio01")
precip <- ee$Image("WORLDCLIM/V1/BIO")$select("bio12")
humid_tropical <- temp$gt(180)$And(precip$gt(1500))

htf_fires <- annual_burn$
  updateMask(forest_mask)$
  updateMask(humid_tropical)

other_forest_fires <- annual_burn$
  updateMask(forest_mask)$
  updateMask(humid_tropical$Not())

# 3b. Savanna Fires
savanna_mask <- lc$gte(6)$And(lc$lte(10))
savanna_fires <- annual_burn$updateMask(savanna_mask)

# 3c. Organic Soil Fires (SE Asia only in FAOSTAT)
# Skip if not in SE Asia, or implement if needed

# 4. CALCULATE AREAS ------------------------------------------
calculateArea <- function(image, name) {
  area <- image$
    multiply(ee$Image$pixelArea()$divide(10000))$
    reduceRegion(
      reducer = ee$Reducer$sum(),
      geometry = aoi,
      scale = 500,
      maxPixels = 1e9
    )
  
  return(ee$Feature(NULL, list(
    fire_type = name,
    area_ha = area$get("burned"),
    year = year,
    country = country_name
  )))
}

results <- ee$FeatureCollection(list(
  calculateArea(htf_fires, "Humid_Tropical_Forest"),
  calculateArea(other_forest_fires, "Other_Forest"),
  calculateArea(savanna_fires, "Savanna")
))

# 5. EXPORT RESULTS -------------------------------------------
results_df <- ee_as_sf(results) %>%
  st_drop_geometry() %>%
  as.data.frame()

print(results_df)

# Save to file
write.csv(
  results_df,
  paste0(country_name, "_VegetationClassification_", year, ".csv"),
  row.names = FALSE
)

# 6. VISUALIZE ------------------------------------------------
Map$centerObject(aoi, zoom = 7)
Map$addLayer(htf_fires, list(palette = "darkred"), "Humid Tropical Forest Fires")
Map$addLayer(other_forest_fires, list(palette = "orange"), "Other Forest Fires")
Map$addLayer(savanna_fires, list(palette = "yellow"), "Savanna Fires")
```

### Output Format for Chapter 3 {#sec-veg-output}

Required outputs for fuel biomass calculation (Chapter 3):

```{r}
#| eval: false
#| label: veg-output-format
#| echo: false

# Example output table structure
output_table <- data.frame(
  country = "Portugal",
  year = 2023,
  fire_type = c("Humid_Tropical_Forest", "Other_Forest", "Savanna"),
  burned_area_ha = c(0, 45230, 12450),  # Example values
  lc_class_dominant = c(NA, 1, 9),  # IGBP class
  climate_zone = c(NA, "Temperate", "Temperate"),
  fuel_consumption_tDM_ha = c(NA, 50.4, 7.0),  # From IPCC Table 2.4
  notes = c(
    "No humid tropical forest in Portugal",
    "Primarily Evergreen Needleleaf (Pinus)",
    "Savanna vegetation"
  )
)

knitr::kable(output_table, caption = "Vegetation Classification Output Example")
```

------------------------------------------------------------

## Quality Control and Uncertainty {#sec-veg-qc}

### Classification Uncertainty Assessment {#sec-veg-uncertainty-assess}

Sources of uncertainty:

1.  Land cover classification error: ±10-15% (MCD12Q1
    validation)
2.  Burned area overlay error: ±2-5% (geometric
    registration)
3.  Ecological zone delineation: ±5-10% (climate proxy vs.
    official zones)
4.  Temporal mismatch: Land cover annual vs. monthly burns

Total uncertainty (quadrature): $$
U_{classification}^2 = U_{landcover}^2 + U_{overlay}^2 + U_{ecozone}^2
$$

Typical result: ±15-20% uncertainty in vegetation type
assignment

### QC Checklist {#sec-veg-qc-checklist}

Pre-classification:

-   Burned area and land cover from same year
-   Land cover projection matches burned area
-   All forest classes (1-5) included in forest mask
-   All savanna classes (6-10) included in savanna mask

Classification:

-   Mutually exclusive categories (no pixel in multiple
    categories)
-   Complete coverage (all burned pixels classified)
-   Climate zones applied correctly
-   Organic soils restricted to validated regions

Post-classification:

-   Area totals match Chapter 1 burned area
-   No negative or unrealistic values
-   Results comparable to previous years (if available)
-   Validation with independent data completed

------------------------------------------------------------

## Chapter Summary and Next Steps {#sec-veg-summary}

### Key Takeaways {#sec-veg-takeaways}

1.  MODIS MCD12Q1 IGBP classification provides globally
    consistent vegetation types
2.  Three IPCC fire categories: Forest (Humid Tropical +
    Other), Savanna, Organic Soils
3.  Climate stratification required for accurate fuel
    consumption assignment
4.  Validation using forestdata products (GLAD, ESRI,
    EU-Trees4F) reduces uncertainty
5.  Uncertainty \~±15-20% in vegetation classification
    acceptable for Tier 1

### Progression to Chapter 3 {#sec-veg-to-chapter3}

Chapter 3: Fuel Biomass Consumption will use vegetation
classifications to:

1.  Assign IPCC default fuel consumption values (Table 2.4)
    by vegetation type
2.  Apply climate-dependent stratification
3.  Calculate total burned biomass: $A \times M_B$ (Activity
    Data × Fuel Biomass)
4.  Prepare for emission factor application (Chapter 4)

Critical linkage: Each vegetation type carries forward:

-   Area burned (hectares) by vegetation type
-   Climate zone (for fuel consumption stratification)
-   Seasonal information (early/late dry season for
    savannas)
-   Geographic location (for validation and reporting)

------------------------------------------------------------

## References {#sec-veg-references}

FAO (2012). Global ecological zones for FAO forest
reporting: 2010 Update. *Forest Resources Assessment Working
Paper 179*. FAO, Rome, Italy.

IPCC (2006). 2006 IPCC Guidelines for National Greenhouse
Gas Inventories, Volume 4: Agriculture, Forestry and Other
Land Use. IGES, Japan.

IPCC (2014). 2013 Supplement to the 2006 IPCC Guidelines for
National Greenhouse Gas Inventories: Wetlands. IPCC,
Switzerland.

Loveland, T.R., & Belward, A.S. (1997). The IGBP-DIS global
1km land cover data set, DISCover: First results.
*International Journal of Remote Sensing*, 18(15),
3289-3295.

Sulla-Menashe, D., & Friedl, M.A. (2022). User Guide to
Collection 6 MODIS Land Cover (MCD12Q1 and MCD12C1) Product.
NASA LP DAAC.
